# 骑手压力标签设计、特征筛选与时空热点识别

第二阶段目标是：

1. **设计“骑手压力”标签（Stress Score）**，形成可量化、连续的目标变量；
2. **筛选压力驱动因素（特征选择）**，明确主要影响因子及其权重；
3. **识别城市高压区域与时段（Hotspot Detection）**，为第三阶段 STGCN 提供节点与标签。

核心输出：

- 连续型压力得分表（rider_id, time, stress_score）
- 高压区域热力图 / 聚类结果（geojson 或 shapefile）
- 关键特征重要性排序（含 SHAP 可解释性分析）

---

## 基于元特征和构造特征的标签设计

### 1. 设计原则

- 连续可解释（用于回归与预测）
- 可分级（用于热点检测与分类）
- 能体现负荷、复杂度、时效压力三方面

### 2. 计算公式（初版可手动加权）

设所有特征都经过 min-max 归一化：

$$
S=w1L+w2C+w3D+w4T+w5W+w6H
$$

其中：

| 符号 | 含义 | 计算方式 | 向压力方向 |
| --- | --- | --- | --- |
| L | 负载强度 | 单位时间任务数 | ↑ |
| C | 连续订单率 | 连续任务比例 | ↑ |
| D | 距离负担 | route 距离 / 耗时 | ↑ |
| T | 交通阻力 | 平均速度 / 拥堵指数 | ↑ |
| W | 等待时长 | 空闲等待时间 / 总时间 | ↑ |
| H | 外部环境 | 天气 + 温度 + 节假日权重 | ↑ |

初始权重 wi=1w_i = 1wi=1 可均分，随后通过模型学习自动优化。

### 3. 数据驱动权重学习

1️⃣ 将上述各维度作为输入特征，

2️⃣ 将某个“压力代理变量”（如平均延迟、任务超时率）作为目标 y，

3️⃣ 使用 **XGBoost 回归** 拟合后提取特征重要性与 SHAP 值：

- SHAP 值高 → 对压力影响大
- 可用来重新分配 wiw_iwi 或直接取模型输出作为最终 Stress Score。

```python
import xgboost as xgb, shap
X = df[['load','cont_orders','dist','traffic','wait','weather']]
y = df['delay_rate']  # 代理变量
model = xgb.XGBRegressor(n_estimators=200, max_depth=4).fit(X, y)
explainer = shap.Explainer(model)
shap_values = explainer(X)
shap.summary_plot(shap_values, X)
df['stress_score'] = model.predict(X)
```

---

## 特征筛选与降维流程

### 1. 相关性分析

- 计算 Spearman 相关系数矩阵
- 删除相关系数 >0.8 的冗余特征

### 2. 多重共线性检测

- 用 VIF（Variance Inflation Factor）过滤共线性强的特征

### 3. 模型筛选

- 训练 XGBoost / Lasso 回归
- 选取前 15~20 个最重要特征作为最终输入

### 4. 可解释性分析

- 使用 SHAP 解释模型输出
- 输出 top 特征贡献图与交互效应分析（影响方向、非线性关系）

---

## 时空热点识别

### 1. 空间聚合

1. 建立 hex/quad 空间网格（约 300m 边长）
2. 将骑手压力数据聚合为 `(grid_id, time_window)` 的平均 stress 值
3. 对时间进行分箱，例如：
    
    ```python
    df['time_bin'] = pd.to_datetime(df['timestamp']).dt.floor('30T')
    ```
    

### 2. ST-DBSCAN 聚类

- 算法：**ST-DBSCAN (Birant & Kut, 2007)**
- 参数含义：
    - `eps_space`: 空间邻域（米）
    - `eps_time`: 时间邻域（分钟）
    - `min_samples`: 聚类最小点数
- 输出：每个 `(grid_id, time_bin)` 的聚类编号或噪声标识

代码示例：

```python
from st_dbscan import ST_DBSCAN
coords = df[['x','y','time']].to_numpy()
st_db = ST_DBSCAN(eps1=300, eps2=30, min_samples=5)
labels = st_db.fit_predict(coords)
df['cluster'] = labels
```

---

## 输出与评估

| 输出名称 | 格式 | 说明 |
| --- | --- | --- |
| `stress_scores.csv` | CSV | 每个 (rider_id, time_bin) 的压力得分 |
| `important_features.json` | JSON | 特征重要性与权重 |
| `hotspot.geojson` | GeoJSON | 聚类或显著性热点结果 |
| `summary_report.md` | Markdown | 分析报告：指标、模型解释、地图截图 |

评估指标：

- 压力得分的分布合理性（均值、方差、极值）
- 聚类结果的空间一致性（Silhouette score）
- 业务验证（热点与投诉 / 延迟区重合度）