# 外卖骑手压力区域识别与预测项目 - 完整说明文档

## 📋 项目概述

本项目是"智慧城市"课程作业，旨在通过分析外卖骑手的配送路线数据，识别和预测骑手压力区域。项目分为三个核心模块：

1. **数据收集与预处理**（模块一）
2. **压力分数计算与分析**（模块二）
3. **时空预测模型**（模块三 - 本模块）

---

## 🏗️ 项目架构

### 目录结构

```
rider_stress_prediction/
├── data/                          # 数据目录
│   ├── raw/                       # 原始数据
│   │   ├── ODIDMob_Routes/        # 原始GeoJSON路线文件（29个=28+1）
│   │   └── map/                   # 地图数据JSON文件（23个）
│   └── processed/                 # 预处理后的数据
│       └── preprocessed_data(28_days)/  # 28天的特征CSV文件
│
├── process/                       # 数据预处理模块
│   └── data_preprocessor.py       # 数据预处理器（从GeoJSON提取特征）
│
├── stress_scoring/                # 压力分数计算模块
│   ├── 智慧城市1(1).py           # 单日压力计算（层级联动方法）
│   └── 智慧城市2(1).py           # 28天压力计算 + XGBoost优化
│
├── prediction/                    # 预测模型模块（你负责的部分）
│   ├── data_loader.py             # 数据加载和序列构建
│   ├── train.py                   # 训练脚本（XGBoost + STGCN）
│   ├── evaluate.py                # 评估工具函数
│   ├── feature_engineering.py     # 特征工程（标准化、图构建）
│   ├── models/
│   │   └── stgcn.py               # STGCN模型实现
│   ├── hotspot_cluster.py         # 时空热点聚类（ST-DBSCAN）
│   └── shap_explain.py            # SHAP可解释性分析
│
├── prediction_output/             # 模型输出目录
│   ├── xgb_model.json             # XGBoost模型文件
│   ├── training_report.json       # 训练报告
│   ├── hotspot_points.csv         # 热点聚类点数据
│   ├── hotspot.geojson            # 热点GeoJSON输出
│   └── ...                        # 其他输出文件
│
├── plan/                          # 项目计划文档
│   ├── 数据预处理.md
│   ├── 时空预测模型.md
│   └── 骑手压力标签设计、特征筛选与时空热点识别.md
│
├── rider_stress_hierarchical_final.csv    # 层级压力分数（模块二输出）
├── xgb_optimized_stress.csv               # XGBoost优化压力分数（模块二输出）
├── xgb_optimized_weights.csv              # XGBoost特征权重（模块二输出）
├── xgb_feature_importance.png             # 特征重要性可视化（模块二输出）
│
└── 项目完整说明文档.md            # 本文档
```

---

## 📊 已完成的工作

### 模块一：数据收集与预处理 ✅

**文件位置：** `process/data_preprocessor.py`

**完成内容：**
- 从原始GeoJSON文件中提取路线（route）和动作点（action_point）数据
- 计算多维度特征：
  - **个体行为特征**：订单频率、平均配送间隔、连续任务量、负载强度、任务多样性
  - **时序动态特征**：平均速度、速度偏差、任务密度、导航时长占比、单位距离任务数
  - **空间特征**：路径曲折度
  - **环境压力特征**：天气评分、时间段分类、拥堵指数
- 按日期输出28天的特征CSV文件（`rider_features_YYYYMMDD.csv`）

**输出文件：**
- `data/processed/preprocessed_data(28_days)/rider_features_20200201.csv` 到 `rider_features_20200228.csv`（28个文件）

**数据规模：**
- 总路线数：约79,648条
- 时间范围：2020年2月1日 - 2020年2月28日
- 骑手数量：约986名

---

### 模块二：压力分数计算与分析 ✅

**文件位置：** `stress_scoring/智慧城市1(1).py` 和 `智慧城市2(1).py`

**完成内容：**

#### 1. 层级联动压力计算（`智慧城市1(1).py`）
- **Route级别压力**：基于累积负载、高峰拥堵、任务密度等特征
- **Action_Point级别压力**：按动作类型（ASSIGN/PICKUP/DELIVERY）差异化权重
- **层级联动**：Route累积系数修正Action_Point压力，峰值压力反哺Route最终分数
- **压力分级**：0-12分映射到低/中/高压力（<4低，4-8中，≥8高）

#### 2. XGBoost优化（`智慧城市2(1).py`）
- 使用XGBoost回归学习特征权重
- 输出优化后的压力分数（0-12分）
- 生成特征重要性排序和权重表
- 生成特征重要性可视化图

**输出文件：**
- `rider_stress_hierarchical_final.csv` - 层级压力分数（Route + Action_Point）
- `xgb_optimized_stress.csv` - XGBoost优化压力分数（75,665条Route记录）
- `xgb_optimized_weights.csv` - XGBoost学到的特征权重
- `xgb_feature_importance.png` - 特征重要性可视化

**关键发现：**
- 压力分数范围：1.38 - 11.39分
- 平均压力：6.36分（中等压力）
- 主要影响因素：负载强度、连续订单、拥堵指数、任务密度

---

### 模块三：时空预测模型 ✅

**文件位置：** `prediction/` 目录

**完成内容：**

#### 1. 数据加载与序列构建（`data_loader.py`）✅
- 加载28天的预处理特征文件
- 合并层级压力分数和XGBoost优化压力分数
- 按`(courier_id, date, time_period)`聚合到时段级别
- 将时间段pivot为宽格式（每个时段一列）
- 添加滞后特征（lag1, lag2, lag3）
- 构建滑动窗口监督样本（支持短窗口和填充策略）

**关键改进：**
- 适应实际数据情况（平均每个骑手只有2-3天数据）
- 支持窗口大小调整（默认3天）
- 处理缺失历史数据（零填充策略）
- 统一日期格式，避免类型混合错误

#### 2. 模型训练（`train.py`）✅
- **XGBoost基线模型**：
  - 按天回归预测压力分数
  - 支持多个目标时段（morning_peak, lunch_peak, day_off_peak, dinner_peak, night）
  - 自动选择有足够数据的目标时段
  - 特征选择：排除目标列，保留滞后特征
  
- **STGCN深度学习模型**（可选）：
  - 时空图卷积网络
  - 捕捉时间演化规律（GRU）
  - 图卷积捕捉空间依赖（单节点示例，可扩展多骑手图）
  - 窗口序列建模（2-3天窗口）

**训练流程：**
```python
python prediction/train.py
```

**输出文件：**
- `prediction_output/xgb_model.json` - XGBoost模型
- `prediction_output/training_report.json` - 训练指标报告
- `prediction_output/stgcn.pt` - STGCN模型权重（如果安装了PyTorch）

#### 3. 模型评估（`evaluate.py`）✅
- 回归指标：MAE、RMSE、R²
- 压力等级分类准确率：低/中/高压力分类准确度
- 支持批量评估和可视化

#### 4. 特征工程（`feature_engineering.py`）✅
- 特征标准化（StandardScaler）
- 交互特征构建
- 相似度图构建（余弦相似度 + kNN）
- 时间序列堆叠（为STGCN准备）

#### 5. 时空热点聚类（`hotspot_cluster.py`）✅
- **ST-DBSCAN算法**：
  - 空间邻域：eps_space_m = 300米
  - 时间邻域：eps_time_h = 2小时
  - 最小样本数：min_samples = 5
  
- **处理流程：**
  1. 从原始JSON文件提取路线坐标（中心点）
  2. 合并压力分数
  3. 网格聚合（cell_size = 0.003度，约300米）
  4. ST-DBSCAN聚类
  5. 生成GeoJSON输出

**使用方法：**
```python
python prediction/hotspot_cluster.py
```

**输出文件：**
- `prediction_output/hotspot_points.csv` - 每个路线的热点标签
- `prediction_output/hotspot_cluster_summary.csv` - 网格聚类统计
- `prediction_output/hotspot.geojson` - 热点GeoJSON（可用于地图可视化）

#### 6. SHAP可解释性分析（`shap_explain.py`）✅
- 使用SHAP TreeExplainer解释XGBoost模型
- 生成特征重要性排名
- 生成SHAP summary plot可视化

**使用方法：**
```python
python prediction/shap_explain.py
```

**输出文件：**
- `prediction_output/shap_values.npy` - SHAP值数组
- `prediction_output/shap_feature_importance.csv` - SHAP特征重要性
- `prediction_output/shap_summary.png` - SHAP可视化图
- `prediction_output/shap_report.json` - SHAP分析报告

---

## 📈 当前项目状态

### ✅ 已完成

1. **数据预处理**：28天数据已处理完成
2. **压力分数计算**：层级联动 + XGBoost优化已完成
3. **预测模型框架**：数据加载、训练脚本、评估工具已实现
4. **热点聚类**：ST-DBSCAN实现完成
5. **可解释性分析**：SHAP分析框架完成

### ⚠️ 需要验证和优化

1. **模型训练**：
   - ✅ 数据加载成功（1,497个样本）
   - ⚠️ 需要安装XGBoost和PyTorch进行实际训练
   - ⚠️ 需要调优超参数以获得更好的预测性能

2. **热点聚类**：
   - ✅ 代码实现完成
   - ⚠️ 需要验证输出结果和聚类质量

3. **SHAP分析**：
   - ✅ 代码框架完成
   - ⚠️ 需要训练模型后再运行

### 📋 待完成事项

1. **运行完整训练流程**：
   ```bash
   # 安装依赖
   pip install xgboost shap
   # 可选：安装PyTorch（用于STGCN）
   pip install torch
   
   # 训练模型
   python prediction/train.py
   ```

2. **生成热点聚类**：
   ```bash
   python prediction/hotspot_cluster.py
   ```

3. **运行SHAP分析**（训练完成后）：
   ```bash
   python prediction/shap_explain.py
   ```

4. **模型评估和调优**：
   - 尝试不同的目标时段
   - 调整窗口大小和滞后特征
   - 优化超参数

5. **结果可视化**：
   - 压力分布热力图
   - 热点聚类地图可视化
   - 预测效果对比图

---

## 🔧 环境配置

### Python版本
- Python 3.8+ 推荐

### 必需依赖
```bash
pip install pandas numpy scikit-learn xgboost shap matplotlib geopandas
```

### 可选依赖（用于STGCN）
```bash
pip install torch
```

### 安装所有依赖
```bash
pip install -r requirements.txt  # 如果创建了requirements.txt
```

**或手动安装：**
```bash
pip install pandas numpy scikit-learn xgboost shap matplotlib geopandas torch
```

---

## 🚀 使用指南

### 1. 数据预处理（模块一 - 已完成）
如果数据更新，重新运行：
```python
python process/data_preprocessor.py
```

### 2. 压力分数计算（模块二 - 已完成）
如果预处理数据更新，重新运行：
```python
python stress_scoring/智慧城市2(1).py
```

### 3. 模型训练（模块三）
```bash
# 基本训练（XGBoost）
python prediction/train.py

# 查看训练报告
cat prediction_output/training_report.json
```

### 4. 热点聚类
```bash
python prediction/hotspot_cluster.py
```

### 5. SHAP分析
```bash
# 需要先训练模型
python prediction/shap_explain.py
```

---

## 📊 数据流概览

```
原始GeoJSON (data/raw/)
    ↓
数据预处理 (process/data_preprocessor.py)
    ↓
特征CSV (data/processed/preprocessed_data(28_days)/)
    ↓
压力分数计算 (stress_scoring/)
    ↓
压力分数CSV (rider_stress_hierarchical_final.csv, xgb_optimized_stress.csv)
    ↓
数据加载 (prediction/data_loader.py)
    ↓
训练数据 (X, y)
    ↓
模型训练 (prediction/train.py)
    ↓
模型输出 (prediction_output/)
    ↓
热点聚类 (prediction/hotspot_cluster.py)
    ↓
SHAP分析 (prediction/shap_explain.py)
    ↓
最终结果和报告
```

---

## 📝 关键代码说明

### 数据加载流程

```python
from prediction.data_loader import prepare_dataset

ds = prepare_dataset(
    processed_root="data/processed/preprocessed_data(28_days)",
    hierarchical_file="rider_stress_hierarchical_final.csv",
    xgb_file="xgb_optimized_stress.csv",
    window=3,  # 历史窗口大小（天）
    horizon=1,  # 预测未来多少天
    target_metric="stress_score__day_off_peak"  # 目标时段
)

# 返回字典包含：
# - raw_routes: 原始路线数据
# - merged: 合并压力分数后的数据
# - agg_timeslice: 聚合到时段的数据
# - pivot: 宽格式数据（时段pivot为列）
# - X: 特征矩阵
# - y: 目标向量
# - meta: 元数据（courier_id, target_date）
```

### 模型训练流程

```python
# XGBoost训练
from prediction.train import train_xgb
result = train_xgb(X, y)
# 返回：模型、指标、模型路径

# STGCN训练（需要PyTorch）
from prediction.train import train_stgcn
result = train_stgcn(pivot_df, window=2, target_metric="...")
```

### 热点聚类流程

```python
from prediction.hotspot_cluster import main
main()  # 自动处理所有路线数据并输出GeoJSON
```

---

## 🎯 项目亮点

1. **完整的端到端流程**：从原始数据到最终预测和可视化
2. **多维度特征工程**：行为、时序、空间、环境四类特征
3. **层级联动压力计算**：Route和Action_Point两级压力建模
4. **机器学习优化**：XGBoost自动学习特征权重
5. **时空建模**：STGCN捕捉时间和空间依赖
6. **热点识别**：ST-DBSCAN识别时空热点区域
7. **可解释性**：SHAP分析提供模型解释

---

## ⚠️ 已知问题和限制

1. **数据量限制**：
   - 平均每个骑手只有2-3天数据
   - 限制了滑动窗口的长度
   - 解决方案：使用较小的窗口（2-3天）或零填充

2. **目标时段数据不均衡**：
   - 不同时段的样本数量差异较大
   - 解决方案：自动选择样本最多的时段或使用加权损失

3. **空间信息缺失**：
   - 当前实现主要基于路线特征，缺少精确的地理坐标
   - 热点聚类使用路线中心点近似

4. **STGCN单节点限制**：
   - 当前实现为单骑手单节点示例
   - 可扩展为多骑手图（基于相似度或地理距离）

---

## 🔮 未来改进方向

1. **多骑手图扩展**：
   - 基于地理距离或特征相似度构建多骑手图
   - 使用GAT（Graph Attention Network）捕捉骑手间交互

2. **更精细的时间建模**：
   - 使用Transformer或Temporal Fusion Transformer
   - 捕捉长期和短期依赖

3. **在线预测**：
   - 增量学习支持
   - 实时压力预测API

4. **可视化增强**：
   - 交互式地图可视化
   - 时间序列预测可视化
   - 热点动画展示

5. **特征增强**：
   - 加入POI密度、路网复杂度等外部特征
   - 天气、节假日等时间特征

---

## 📚 参考资料

- 项目计划文档：`plan/` 目录
- 原始说明文档：`说明文档_项目总览与时空预测.md`
- XGBoost文档：https://xgboost.readthedocs.io/
- SHAP文档：https://shap.readthedocs.io/
- ST-DBSCAN论文：Birant, D., & Kut, A. (2007). ST-DBSCAN: An algorithm for clustering spatial–temporal data

---

## 👥 团队成员分工

- **模块一（数据预处理）**：组员A
- **模块二（压力分数计算）**：组员B
- **模块三（时空预测模型）**：组长

---

**最后更新日期：** 2025/11/15

**项目状态：** ✅ 核心功能已实现，待完整测试和优化

